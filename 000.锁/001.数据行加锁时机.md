# MySQL数据行加锁时机

&nbsp;&nbsp;MySQL只有在访问行的时候才会对其加锁<sup>加锁时机</sup>，而索引能够减少InnoDB访问的行数，从而减少锁的数量。但是这只有当InnoDB在存储引擎层能够过滤掉所有不需要的行时才有效。

&nbsp;&nbsp;**如果索引无法过滤掉无效的行，那么在InnoDB检索到数据并返回给服务层以后，MySQL才能应用WHERE语句**<sup>注释一</sup>。 这时候已无法避免锁定行了： InnoDB已经锁住了这些行<sub>在存储引擎返回数据到核心服务层时加锁</sub>，到了适当的时候才释放。
- 在MySQL5.1和更新的版本中，InnoDB可以在服务器层过滤掉行后就释放锁<sub>违背了二段锁机制，提升并发性能</sub>，但是在早起的版本中，InnoDB只能在事务提交后才能释放锁<sub>二段锁机制</sub>。


--------
## 注释
##### 注释一
&nbsp;&nbsp;在InnoDB中，因为针对于索引有优化，所以where语句也可以应用到存储引擎层，例如： 索引下推

--------
## 参考资料
1. 《高性能MySQL》 第五章 5.3.11 索引和锁