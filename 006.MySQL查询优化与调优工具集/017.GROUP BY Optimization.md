# GROUP BY Optimization
## 摘要
+ 通过索引，在 GROUP BY 查询中可以使用索引扫描来避免创建临时表
## 文档内容
&nbsp;&nbsp;The most general way to satisfy a GROUP BY clause is to scan the whole table and create a new temporary table where all rows from each group are consecutive, and then use this temporary table to discover groups and apply aggregate functions (if any). In some cases, MySQL is able to do much better than that and avoid creation of temporary tables by using index access.(满足GROUP BY子句的最常见方法是扫描整个表并创建一个新的临时表，其中每个组的所有行都是连续的，然后使用这个临时表来发现组并应用聚合函数(如果有的话)。在某些情况下，MySQL可以做得更好，通过使用索引访问来避免创建临时表。)

&nbsp;&nbsp;The most important preconditions for using indexes for GROUP BY are that all GROUP BY columns reference attributes from the same index, and that the index stores its keys in order (as is true, for example, for a BTREE index, but not for a HASH index). Whether use of temporary tables can be replaced by index access also depends on which parts of an index are used in a query, the conditions specified for these parts, and the selected aggregate functions.(GROUP BY 使用索引最重要的前提条件是所有GROUP BY列都引用同一个索引中的字段，并且索引中的字段是按照顺序存储(例如，对于BTREE索引是这样，但对于HASH索引则不是)。是否可以用索引访问代替临时表的使用，还取决于查询中使用了索引的哪些部分、为这些部分指定的条件以及所选的聚集函数。)

&nbsp;&nbsp;There are two ways to execute a GROUP BY query through index access, as detailed in the following sections. The first method applies the grouping operation together with all range predicates (if any). The second method first performs a range scan, and then groups the resulting tuples.(GROUP BY 查询有两种使用索引的方法，第一种方法将分组操作与所有范围谓词(如果有的话)一起应用。第二种方法首先执行范围扫描，然后对结果元组进行分组。)

&nbsp;&nbsp;Loose Index Scan can also be used in the absence of GROUP BY under some conditions. See [Skip Scan Range Access Method](https://dev.mysql.com/doc/refman/8.2/en/range-optimization.html#range-access-skip-scan).(在某些条件下，松散索引扫描也可以在没有GROUP BY的情况下使用。)

### GROUP BY 查询使用索引场景方式一： Loose Index Scan
&nbsp;&nbsp;The most efficient way to process GROUP BY is when an index is used to directly retrieve the grouping columns.  With this access method, MySQL uses the property of some index types that the keys are ordered (for example, BTREE).  This property enables use of lookup groups in an index without having to consider all keys in the index that satisfy all WHERE conditions.  This access method considers only a fraction of the keys in an index, so it is called a Loose Index Scan.  When there is no WHERE clause, a Loose Index Scan reads as many keys as the number of groups, which may be a much smaller number than that of all keys.  If the WHERE clause contains range predicates , a Loose Index Scan looks up the first key of each group that satisfies the range conditions, and again reads the smallest possible number of keys.  This is possible under the following conditions:(处理GROUP BY的最有效方法是使用索引直接检索分组列。使用这种访问方法，MySQL要求索引是有序的(例如BTREE)。这个属性允许在索引中使用查找组，而不必考虑索引中满足所有WHERE条件的所有键。这种访问方法只考虑索引中的一小部分键，因此称为松散索引扫描(Loose index Scan)。当没有WHERE子句时，松散索引扫描读取的键数目与组的数目相同，这可能比所有键的数目小得多。如果WHERE子句包含范围谓词，松散索引扫描将查找满足范围条件的每组的第一个键，并再次读取尽可能少的键。这在以下情况下是可能的:)
+ The query is over a single table.(查询在单个表上)
+ The GROUP BY names only columns that form a leftmost prefix of the index and no other columns. (If, instead of GROUP BY, the query has a DISTINCT clause, all distinct attributes refer to columns that form a leftmost prefix of the index.) For example, if a table group_by_ab has an index on (c1,c2,c3), Loose Index Scan is applicable if the query has GROUP BY c1, c2. It is not applicable if the query has GROUP BY c2, c3 (the columns are not a leftmost prefix) or GROUP BY c1, c2, c4 (c4 is not in the index).(GROUP BY只命名构成索引最左边前缀的列，不命名其他列。（如果查询具有DISTINCT子句而不是GROUP BY，则所有不同的属性都引用构成索引最左边前缀的列。）例如，如果表group_by_ab在（c1，c2，c3）上具有索引，则如果查询具有GROUP BY c1，c2则适用松散索引扫描。如果查询具有GROUP BY c2、c3（列不是最左边的前缀）或GROUP BY c1、c2、c4（c4不在索引中），则不适用)
+ The only aggregate functions used in the select list (if any) are MIN() and MAX(), and all of them refer to the same column. The column must be in the index and must immediately follow the columns in the GROUP BY.(选择列表中使用的唯一聚合函数（如果有的话）是MIN（）和MAX（），它们都引用同一列。列必须在索引中，并且必须紧跟在GROUP BY中的列之后)
+ Any other parts of the index than those from the GROUP BY referenced in the query must be constants (that is, they must be referenced in equalities with constants), except for the argument of MIN() or MAX() functions.(除了查询中引用的组以外，索引的任何其他部分都必须是常量(也就是说，它们必须在具有常量的等式中引用)，MIN()或MAX()函数的参数除外)
+ For columns in the index, full column values must be indexed, not just a prefix. For example, with c1 VARCHAR(20), INDEX (c1(10)), the index uses only a prefix of c1 values and cannot be used for Loose Index Scan.(对于索引中的列，必须索引完整的列值，而不仅仅是前缀。例如，对于c1 VARCHAR(20)， INDEX (c1(10))，索引只使用c1值的前缀，不能用于松散索引扫描。)

&nbsp;&nbsp;If Loose Index Scan is applicable to a query, the EXPLAIN output shows Using index for group-by in the Extra column.（如果Loose Index Scan适用于查询，那么EXPLAIN输出中就会展示Using index for group-by）
```txt
   如下测试，在8.0.30-debug 版本中，并不会在Extra中出现 'Using index for group-by'
     按照 'EXPLAIN SELECT a, MAX(d), MIN(d) FROM t  WHERE (b = 2 OR b = 15 OR b = 3) AND (c = 3 OR c = 40) GROUP BY a;'测试，也并没有出现 'Using index for group-by'
       > 来源于文件: 001.SOURCE_CODE/001.mysql-server-8.0.30-GA/mysql-8.0.30-server/mysql-test/r/group_min_max_ext.result 

   在MySQL5.7中呢?(5.7.34-debug)
    > 和'8.0.30-debug'一样，并未出现 'Using index for group-by' 
```

&nbsp;&nbsp;Assume that there is an index idx(c1,c2,c3) on table group_by_ab(c1,c2,c3,c4). The Loose Index Scan access method can be used for the following queries:(假设表group_by_ab(c1,c2,c3,c4)上有一个索引idx(c1,c2,c3)。松散索引扫描访问方法可用于以下查询:)
```sql
    explain format=tree SELECT c1, c2 FROM group_by_ab GROUP BY c1, c2;
    explain format=tree SELECT DISTINCT c1, c2 FROM group_by_ab;
    explain format=tree SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
    explain format=tree SELECT c1, c2 FROM group_by_ab WHERE c1 < const GROUP BY c1, c2;
    explain format=tree SELECT MAX(c3), MIN(c3), c1, c2 FROM group_by_ab WHERE c2 > const GROUP BY c1, c2;
    explain format=tree SELECT c2 FROM group_by_ab WHERE c1 < const GROUP BY c1, c2;
    explain format=tree SELECT c1, c2 FROM group_by_ab WHERE c3 = const GROUP BY c1, c2; 
```

#### 测试一下
##### 表 & 数据
```sql
  mysql> select version();
  +--------------+
  | version()    |
  +--------------+
  | 8.0.30-debug |
  +--------------+
  1 row in set (0.00 sec)

  # 创建测试表,已插入2w数据
  mysql> show create table group_by_ab\G
  *************************** 1. row ***************************
         Table: group_by_ab
  Create Table: CREATE TABLE `group_by_ab` (
    `c1` varchar(100) DEFAULT NULL,
    `c2` varchar(100) DEFAULT NULL,
    `c3` varchar(100) DEFAULT NULL,
    `c4` varchar(100) DEFAULT NULL,
    `id` bigint NOT NULL AUTO_INCREMENT,
    PRIMARY KEY (`id`),
    KEY `aaa` (`c1`,`c2`,`c3`)
  ) ENGINE=InnoDB AUTO_INCREMENT=20001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci
  1 row in set (0.01 sec)
```

##### 来自官方的测试资料
```sql
  # 如文件: 001.SOURCE_CODE/001.mysql-server-8.0.30-GA/mysql-8.0.30-server/mysql-test/r/bench_count_distinct.result
  # 示例1
  mysql> create table t1_aa(n int not null, key(n));
  Query OK, 0 rows affected (0.10 sec)
  
  mysql> select count(distinct n) from t1_aa;
  +-------------------+
  | count(distinct n) |
  +-------------------+
  |                 0 |
  +-------------------+
  1 row in set (0.01 sec)
  
  mysql> explain select count(distinct n) from t1_aa;
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------------------------------+
  | id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                               |
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------------------------------+
  |  1 | SIMPLE      | t1_aa | NULL       | range | n             | n    | 4       | NULL |    2 |   100.00 | Using index for group-by (scanning) |
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+-------------------------------------+
  1 row in set, 1 warning (0.00 sec)
  mysql> explain format=tree select count(distinct n) from t1_aa;
  +---------------------------------------------------------------------------------------------------------------------------------------------------+
  | EXPLAIN                                                                                                                                           |
  +---------------------------------------------------------------------------------------------------------------------------------------------------+
  | -> Aggregate: count(distinct t1_aa.n)  (cost=0.40 rows=1)
      -> Covering index skip scan for deduplication on t1_aa using n  (cost=0.20 rows=2) # 索引跳跃扫描(Index Skip Scan)
   |
  +---------------------------------------------------------------------------------------------------------------------------------------------------+
  1 row in set (0.01 sec)

  ## 示例2: 001.SOURCE_CODE/001.mysql-server-8.0.30-GA/mysql-8.0.30-server/mysql-test/r/group_min_max_ext.result 
  mysql> CREATE TABLE t (a INT, b INT, c INT, d INT, KEY k1(a, b, c, d)) ENGINE=innodb;
  Query OK, 0 rows affected (0.09 sec)
  
  mysql> EXPLAIN SELECT a, MAX(d), MIN(d) FROM t  WHERE (b = 2 OR b = 15 OR b = 3) AND (c = 3 OR c = 40) GROUP BY a;
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
  | id | select_type | table | partitions | type  | possible_keys | key  | key_len | ref  | rows | filtered | Extra                    |
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
  |  1 | SIMPLE      | t     | NULL       | index | k1            | k1   | 20      | NULL |    1 |   100.00 | Using where; Using index |
  +----+-------------+-------+------------+-------+---------------+------+---------+------+------+----------+--------------------------+
  1 row in set, 1 warning (0.01 sec)
  
  mysql> 
  资料中的输出:
    EXPLAIN SELECT a, MAX(d), MIN(d) FROM t  WHERE (b = 2 OR b = 15 OR b = 3) AND (c = 3 OR c = 40) GROUP BY a;
    id	select_type	table	partitions	type	possible_keys	key	key_len	ref	rows	filtered	Extra
    1	SIMPLE	t	NULL	range	k1	k1	20	NULL	78	100.00	Using where; Using index for group-by
```

##### 有索引测试: SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
```sql
   mysql> explain SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
   +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+-------------+
   | id | select_type | table       | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra       |
   +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+-------------+
   |  1 | SIMPLE      | group_by_ab | NULL       | index | aaa           | aaa  | 1209    | NULL | 19886 |   100.00 | Using index |
   +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+-------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> explain format=tree SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
   +-------------------------------------------------------------------------------------------------------------------------------------------+
   | EXPLAIN                                                                                                                                   |
   +-------------------------------------------------------------------------------------------------------------------------------------------+
   | -> Group aggregate: min(group_by_ab.c2)  (cost=4033.45 rows=19886)
       -> Index scan on group_by_ab using aaa  (cost=2044.85 rows=19886)
    |
   +-------------------------------------------------------------------------------------------------------------------------------------------+
   1 row in set (0.01 sec)
   
   mysql> explain format=json SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
   +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
   +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   | {
     "query_block": {
       "select_id": 1,
       "cost_info": {
         "query_cost": "2044.85"
       },
       "grouping_operation": {
         "using_filesort": false,
         "table": {
           "table_name": "group_by_ab",
           "access_type": "index",
           "possible_keys": [
             "aaa"
           ],
           "key": "aaa",
           "used_key_parts": [
             "c1",
             "c2",
             "c3"
           ],
           "key_length": "1209",
           "rows_examined_per_scan": 19886,
           "rows_produced_per_join": 19886,
           "filtered": "100.00",
           "using_index": true,
           "cost_info": {
             "read_cost": "56.25",
             "eval_cost": "1988.60",
             "prefix_cost": "2044.85",
             "data_read_per_join": "30M"
           },
           "used_columns": [
             "c1",
             "c2",
             "id"
           ]
         }
       }
     }
   } |
   +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
   1 row in set, 1 warning (0.00 sec)
   
   mysql> 
```
##### 有索引测试: SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
```sql
    mysql> explain SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
    +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+--------------------------+
    | id | select_type | table       | partitions | type  | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                    |
    +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+--------------------------+
    |  1 | SIMPLE      | group_by_ab | NULL       | index | aaa           | aaa  | 1209    | NULL | 19886 |    50.00 | Using where; Using index |
    +----+-------------+-------------+------------+-------+---------------+------+---------+------+-------+----------+--------------------------+
    1 row in set, 1 warning (0.01 sec)
    
    mysql> explain format=tree SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
    +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | EXPLAIN                                                                                                                                                                                                         |
    +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | -> Group (no aggregates)  (cost=3039.15 rows=9943)
        -> Filter: (group_by_ab.c1 < '1385833848548454355')  (cost=2044.85 rows=9943)
            -> Index scan on group_by_ab using aaa  (cost=2044.85 rows=19886)
     |
    +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    1 row in set (0.01 sec)
    
    mysql> explain format=json SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
    +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
    +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    | {
      "query_block": {
        "select_id": 1,
        "cost_info": {
          "query_cost": "2044.85"
        },
        "grouping_operation": {
          "using_filesort": false,
          "table": {
            "table_name": "group_by_ab",
            "access_type": "index",
            "possible_keys": [
              "aaa"
            ],
            "key": "aaa",
            "used_key_parts": [
              "c1",
              "c2",
              "c3"
            ],
            "key_length": "1209",
            "rows_examined_per_scan": 19886,
            "rows_produced_per_join": 9943,
            "filtered": "50.00",
            "using_index": true,
            "cost_info": {
              "read_cost": "1050.55",
              "eval_cost": "994.30",
              "prefix_cost": "2044.85",
              "data_read_per_join": "15M"
            },
            "used_columns": [
              "c1",
              "c2",
              "id"
            ],
            "attached_condition": "(`stu`.`group_by_ab`.`c1` < '1385833848548454355')"
          }
        }
      }
    } |
+------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set, 1 warning (0.01 sec)

mysql> 
```
##### 无索引测试: SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
```sql
  # 已删除索引aaa
  mysql> explain SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
  +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+-----------------+
  | id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra           |
  +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+-----------------+
  |  1 | SIMPLE      | group_by_ab | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 19886 |   100.00 | Using temporary |
  +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+-----------------+
  1 row in set, 1 warning (0.00 sec)
  
  mysql> explain format=tree  SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
  +--------------------------------------------------------------------------------------------------------------------------------------+
  | EXPLAIN                                                                                                                              |
  +--------------------------------------------------------------------------------------------------------------------------------------+
  | -> Table scan on <temporary>
      -> Aggregate using temporary table
          -> Table scan on group_by_ab  (cost=2044.85 rows=19886)
   |
  +--------------------------------------------------------------------------------------------------------------------------------------+
  1 row in set (0.00 sec)
  
  mysql> explain format=json  SELECT c1, MIN(c2) FROM group_by_ab GROUP BY c1;
  +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  | EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
  +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  | {
    "query_block": {
      "select_id": 1,
      "cost_info": {
        "query_cost": "2044.85"
      },
      "grouping_operation": {
        "using_temporary_table": true,
        "using_filesort": false,
        "table": {
          "table_name": "group_by_ab",
          "access_type": "ALL",
          "rows_examined_per_scan": 19886,
          "rows_produced_per_join": 19886,
          "filtered": "100.00",
          "cost_info": {
            "read_cost": "56.25",
            "eval_cost": "1988.60",
            "prefix_cost": "2044.85",
            "data_read_per_join": "30M"
          },
          "used_columns": [
            "c1",
            "c2",
            "id"
          ]
        }
      }
    }
  } |
  +-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
  1 row in set, 1 warning (0.00 sec)
  
  mysql> 
```
##### 无索引测试:SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
```sql
     # 已删除索引aaa
     mysql> explain SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
     +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+------------------------------+
     | id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows  | filtered | Extra                        |
     +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+------------------------------+
     |  1 | SIMPLE      | group_by_ab | NULL       | ALL  | NULL          | NULL | NULL    | NULL | 19886 |    33.33 | Using where; Using temporary |
     +----+-------------+-------------+------------+------+---------------+------+---------+------+-------+----------+------------------------------+
     1 row in set, 1 warning (0.00 sec)
     
     mysql> explain format=tree  SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
     +----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     | EXPLAIN                                                                                                                                                                                                                                                                                            |
     +----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     | -> Table scan on <temporary>  (cost=0.01..85.35 rows=6628)
         -> Temporary table with deduplication  (cost=2707.66..2793.00 rows=6628)
             -> Filter: (group_by_ab.c1 < '1385833848548454355')  (cost=2044.85 rows=6628)
                 -> Table scan on group_by_ab  (cost=2044.85 rows=19886)
      |
     +----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     1 row in set (0.00 sec)
     
     mysql> explain format=json  SELECT c1, c2 FROM group_by_ab WHERE c1 < '1385833848548454355' GROUP BY c1, c2;
     +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     | EXPLAIN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
     +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     | {
       "query_block": {
         "select_id": 1,
         "cost_info": {
           "query_cost": "2044.85"
         },
         "grouping_operation": {
           "using_temporary_table": true,
           "using_filesort": false,
           "table": {
             "table_name": "group_by_ab",
             "access_type": "ALL",
             "rows_examined_per_scan": 19886,
             "rows_produced_per_join": 6628,
             "filtered": "33.33",
             "cost_info": {
               "read_cost": "1382.05",
               "eval_cost": "662.80",
               "prefix_cost": "2044.85",
               "data_read_per_join": "10M"
             },
             "used_columns": [
               "c1",
               "c2",
               "id"
             ],
             "attached_condition": "(`stu`.`group_by_ab`.`c1` < '1385833848548454355')"
           }
         }
       }
     } |
     +------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
     1 row in set, 1 warning (0.00 sec)
     
     mysql> 
```

&nbsp;&nbsp;The following queries cannot be executed with this quick select method, for the reasons given:(下面的查询无法使用快速选择方法执行，原因如下:)
- There are aggregate functions other than MIN() or MAX():(除了MIN()和MAX()之外，还有其他聚合函数:)
  ```sql
     SELECT c1, SUM(c2) FROM group_by_ab GROUP BY c1;
  ```
- The columns in the GROUP BY clause do not form a leftmost prefix of the index:(GROUP BY子句中的列并不构成索引最左侧的前缀:)
  ```sql
     SELECT c1, c2 FROM group_by_ab GROUP BY c2, c3;
  ```
- The query refers to a part of a key that comes after the GROUP BY part, and for which there is no equality with a constant:（查询指的是键的一部分，它跟在分组后面，和常量不相等）
  ```sql
     SELECT c1, c3 FROM group_by_ab GROUP BY c1, c2;
  ```
&nbsp;&nbsp;Were the query to include WHERE c3 = const, Loose Index Scan could be used.（当查询条件包含c3=const,则Loose Index Scan将会被使用）

&nbsp;&nbsp;The Loose Index Scan access method can be applied to other forms of aggregate function references in the select list, in addition to the MIN() and MAX() references already supported:（除了已经支持的MIN()和MAX()引用外，松散索引扫描访问方法还可以应用于select列表中其他形式的聚集函数引用）
+ AVG(DISTINCT), SUM(DISTINCT), and COUNT(DISTINCT) are supported. AVG(DISTINCT) and SUM(DISTINCT) take a single argument. COUNT(DISTINCT) can have more than one column argument.
+ There must be no GROUP BY or DISTINCT clause in the query.
+ The Loose Index Scan limitations described previously still apply.

&nbsp;&nbsp;Assume that there is an index idx(c1,c2,c3) on table group_by_ab(c1,c2,c3,c4). The Loose Index Scan access method can be used for the following queries:(可以使用Loose Index Scan 扫描的访问方式)
```sql
    SELECT COUNT(DISTINCT c1), SUM(DISTINCT c1) FROM group_by_ab;
    
    SELECT COUNT(DISTINCT c1, c2), COUNT(DISTINCT c2, c1) FROM group_by_ab;
```

### GROUP BY 查询使用索引场景方式二： Tight Index Scan
&nbsp;&nbsp;A Tight Index Scan may be either a full index scan or a range index scan, depending on the query conditions.(紧密索引扫描可以是完整索引扫描，也可以是范围索引扫描，具体取决于查询条件。)

&nbsp;&nbsp;When the conditions for a Loose Index Scan are not met, it still may be possible to avoid creation of temporary tables for GROUP BY queries. If there are range conditions in the WHERE clause, this method reads only the keys that satisfy these conditions. Otherwise, it performs an index scan. Because this method reads all keys in each range defined by the WHERE clause, or scans the whole index if there are no range conditions, it is called a Tight Index Scan. With a Tight Index Scan, the grouping operation is performed only after all keys that satisfy the range conditions have been found.(当松散索引扫描的条件不满足时，仍然可以避免为GROUP BY查询创建临时表。如果WHERE子句中有范围条件，则此方法只读取满足这些条件的键。否则，执行索引扫描。由于该方法读取由WHERE子句定义的每个范围中的所有键，或者在没有范围条件的情况下扫描整个索引，因此称为紧密索引扫描。使用紧密索引扫描，只有在找到满足范围条件的所有键之后才执行分组操作。)

&nbsp;&nbsp;For this method to work, it is sufficient that there be a constant equality condition for all columns in a query referring to parts of the key coming before or in between parts of the GROUP BY key. The constants from the equality conditions fill in any “gaps” in the search keys so that it is possible to form complete prefixes of the index. These index prefixes then can be used for index lookups. If the GROUP BY result requires sorting, and it is possible to form search keys that are prefixes of the index, MySQL also avoids extra sorting operations because searching with prefixes in an ordered index already retrieves all the keys in order.(要使此方法工作，查询中的所有列都有一个恒定的相等条件，这些列引用GROUP BY键各部分之前或之间的键部分。等式条件中的常量会填补搜索关键字中的任何“空白”，这样就有可能形成完整的索引前缀。然后，这些索引前缀可用于索引查找。如果GROUP BY结果需要排序，并且有可能形成索引前缀的搜索键，MySQL还会避免额外的排序操作，因为在有序索引中使用前缀进行搜索已经按顺序检索了所有键。)

&nbsp;&nbsp;Assume that there is an index idx(c1,c2,c3) on table group_by_ab(c1,c2,c3,c4). The following queries do not work with the Loose Index Scan access method described previously, but still work with the Tight Index Scan access method.(假设表group_by_ab(c1,c2,c3,c4)上有一个索引idx(c1,c2,c3)。以下查询不适用于前面描述的松散索引扫描访问方法，但仍然适用于紧密索引扫描访问方法。)

+ There is a gap in the GROUP BY, but it is covered by the condition c2 = 'a':
  ```sql
  SELECT c1, c2, c3 FROM group_by_ab WHERE c2 = 'a' GROUP BY c1, c3;
  ```
+ The GROUP BY does not begin with the first part of the key, but there is a condition that provides a constant for that part:
  ```sql
  SELECT c1, c2, c3 FROM group_by_ab WHERE c1 = 'a' GROUP BY c2, c3;
  ```

## 参考资料
1. [ GROUP BY Optimization](https://dev.mysql.com/doc/refman/8.2/en/group-by-optimization.html)