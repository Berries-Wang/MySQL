# 线上数据统计： 参与活动时是非会员数量
> 即，在同一张表中对某一个维度进行分组，再计算每组数据中的极值

## 背景
&nbsp;&nbsp;线上活动已结束，需要统计有多少参与活动的买家在进入时是非会员身份，从而统计入会率。

## 解决方案
&nbsp;&nbsp;先查询最早进入活动的日志ID，再判断是否是会员.

&nbsp;&nbsp;表结构如下:
```sql
   # 打点数据表
    mysql> show create table activity_log_data_info\G
    *************************** 1. row ***************************
           Table: activity_log_data_info
    Create Table: CREATE TABLE `activity_log_data_info` (
      `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增主键',
      `gmt_created` datetime NOT NULL COMMENT '创建时间',
      `gmt_modified` datetime NOT NULL COMMENT '更新时间',
      `open_id` varchar(64) DEFAULT NULL COMMENT '卖家openId',
      `activity_id` varchar(64) NOT NULL COMMENT '活动ID',
      `data_type` varchar(20) NOT NULL COMMENT '数据类型',
      `ext_col_1` varchar(100) DEFAULT NULL COMMENT '拓展字段1',
      `buyer_open_id` varchar(64) NOT NULL COMMENT '买家',
      PRIMARY KEY (`id`),
      KEY `idx_buyer_activity` (`open_id`,`activity_id`,`buyer_open_id`)
    ) ENGINE=InnoDB AUTO_INCREMENT=11 DEFAULT CHARSET=utf8mb4

   # JOIN_MEM 表示是入会打点数据
   # ext_col_1 IS MEM: 表示是会员;NOT MEM:不是会员;

   mysql> select * from activity_log_data_info;
   +----+---------------------+---------------------+------------------+---------------+-----------+-----------+-----------------+
   | id | gmt_created         | gmt_modified        | open_id          | activity_id   | data_type | ext_col_1 | buyer_open_id   |
   +----+---------------------+---------------------+------------------+---------------+-----------+-----------+-----------------+
   |  1 | 2024-03-20 22:25:32 | 2024-03-20 22:25:32 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_1 |
   |  2 | 2024-03-20 22:25:34 | 2024-03-20 22:25:34 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_1 |
   |  3 | 2024-03-20 22:25:58 | 2024-03-20 22:25:58 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_2 |
   |  4 | 2024-03-20 22:26:01 | 2024-03-20 22:26:01 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_3 |
   |  5 | 2024-03-20 22:26:03 | 2024-03-20 22:26:03 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_1 |
   |  6 | 2024-03-20 22:26:06 | 2024-03-20 22:26:06 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_2 |
   |  7 | 2024-03-20 22:26:13 | 2024-03-20 22:26:13 | seller_open_id_1 | activity_id_1 | JOIN MEM  | NOT MEM   | buyer_open_id_3 |
   |  8 | 2024-03-20 22:26:28 | 2024-03-20 22:26:28 | seller_open_id_1 | activity_id_1 | JOIN MEM  | NOT MEM   | buyer_open_id_4 |
   |  9 | 2024-03-20 22:26:34 | 2024-03-20 22:26:34 | seller_open_id_1 | activity_id_1 | JOIN MEM  | IS MEM    | buyer_open_id_4 |
   | 10 | 2024-03-20 22:26:41 | 2024-03-20 22:26:41 | seller_open_id_1 | activity_id_1 | JOIN MEM  | NOT MEM   | buyer_open_id_5 |
   +----+---------------------+---------------------+------------------+---------------+-----------+-----------+-----------------+
   10 rows in set (0.00 sec)

   # 那么如何统计进入活动时，买家的身份是非会员的呢?
     > 思路： 找到最早进入活动的那条日志，如果是非会员，那么就说明该买家首次进入该活动时是以非会员身份进入的。
     >>> 如何找到买家首次进入活动时的打点日志呢?
         >>>> 通过将打点日志按照买家分组，查询组里最小ID的日志(ID是单调递增的，所以最小的那一条就是最早的那一条打点日志)，那么这条日志就是买家首次进入活动的日志
      
      # 1. 找到首次进入的日志id 
      mysql> select buyer_open_id , min(id) as logId from activity_log_data_info where data_type = 'JOIN MEM' and open_id = 'seller_open_id_1' and activity_id = 'activity_id_1' group by buyer_open_id;
      +-----------------+-------+
      | buyer_open_id   | logId |
      +-----------------+-------+
      | buyer_open_id_1 |     1 |
      | buyer_open_id_2 |     3 |
      | buyer_open_id_3 |     4 |
      | buyer_open_id_4 |     8 |
      | buyer_open_id_5 |    10 |
      +-----------------+-------+
      5 rows in set (0.01 sec)

      # 2. 通过日志ID关联打点数据表，得出最终的判断： 首次进入是否是会员?
      mysql> select aldf.buyer_open_id from activity_log_data_info as aldf inner join (select buyer_open_id , min(id) as logId from activity_log_data_info where data_type = 'JOIN MEM' and open_id = 'seller_open_id_1' and activity
_id = 'activity_id_1' group by buyer_open_id) as first_times on aldf.id = first_times.logId where aldf.ext_col_1 = 'NOT MEM';
      +-----------------+
      | buyer_open_id   |
      +-----------------+
      | buyer_open_id_4 |
      | buyer_open_id_5 |
      +-----------------+
      2 rows in set (0.00 sec)
      > 因此可以发现，只有  buyer_open_id_4  buyer_open_id_5 两人首次进入时是以非会员身份进入的。
```



