# InnoDB Full-Text Indexes
## 摘要

## 正文
Full-text indexes are created on text-based columns (CHAR, VARCHAR, or TEXT columns) to speed up queries and DML operations on data contained within those columns. (全文索引是在基于文本的列(CHAR、VARCHAR或TEXT列)上创建的，以加快对这些列中包含的数据的查询和DML操作。)

A full-text index is defined as part of a CREATE TABLE statement or added to an existing table using ALTER TABLE or CREATE INDEX. (全文索引定义为CREATE TABLE语句的一部分，或者使用ALTER TABLE或CREATE index将全文索引添加到现有表中。)

Full-text search is performed using MATCH() ... AGAINST syntax. (全文搜索使用MATCH()…AGAINST语法。) , 语法参考:[Full-Text Search Functions](#1-full-text-search-functions)

### InnoDB Full-Text Index Design <sup>倒排索引设计</sup>
InnoDB full-text indexes have an inverted index design. Inverted indexes store a list of words, and for each word, a list of documents that the word appears in. To support proximity search, position information for each word is also stored, as a byte offset.(InnoDB全文索引采用了倒排索引设计。倒排索引存储一个单词列表，对于每个单词，存储该单词出现在其中的文档列表。为了支持邻近搜索，每个字的位置信息也以字节偏移量的形式存储。)

### InnoDB Full-Text Index Tables
When an InnoDB full-text index is created, a set of index tables is created, as shown in the following example:（创建InnoDB全文索引时，会创建一组索引表，示例如下:）
```sql
   DB: stu
   Server version: 5.7.34-debug-log Source distribution

   mysql> show create table opening_lines\G
   *************************** 1. row ***************************
          Table: opening_lines
   Create Table: CREATE TABLE `opening_lines` (
     `id` int(10) unsigned NOT NULL AUTO_INCREMENT,
     `opening_line` text,
     `author` varchar(200) DEFAULT NULL,
     `title` varchar(200) DEFAULT NULL,
     PRIMARY KEY (`id`),
     FULLTEXT KEY `idx` (`opening_line`)
   ) ENGINE=InnoDB DEFAULT CHARSET=latin1
   1 row in set (0.00 sec)
   
   mysql> 

   # 查看指定目录文件 , 查看新增文件(表未创建前的文件未展示)
   wei@Wang:~/WorkSpace/open_source/MySQL/001.SOURCE_CODE/000.mysql-server-5.7/build/000.build-scripts/data/stu$ ls -la
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_1.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_2.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_3.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_4.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_5.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_000000000000004d_INDEX_6.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_BEING_DELETED_CACHE.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_BEING_DELETED.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_CONFIG.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_DELETED_CACHE.ibd
   -rw-r----- 1 wei wei  98304 Apr  1 23:14 FTS_0000000000000036_DELETED.ibd
   -rw-r----- 1 wei wei   8668 Apr  1 23:14 opening_lines.frm
   -rw-r----- 1 wei wei 114688 Apr  1 23:14 opening_lines.ibd

   mysql> use INFORMATION_SCHEMA;
   mysql> select table_id,name,space from INNODB_SYS_TABLES where name LIKE 'stu/%';
   +----------+---------------------------------------------------+-------+
   | table_id | name                                              | space |
   +----------+---------------------------------------------------+-------+
   |       72 | stu/FTS_0000000000000042_000000000000005b_INDEX_1 |   105 |
   |       73 | stu/FTS_0000000000000042_000000000000005b_INDEX_2 |   106 |
   |       74 | stu/FTS_0000000000000042_000000000000005b_INDEX_3 |   107 |
   |       75 | stu/FTS_0000000000000042_000000000000005b_INDEX_4 |   108 |
   |       76 | stu/FTS_0000000000000042_000000000000005b_INDEX_5 |   109 |
   |       77 | stu/FTS_0000000000000042_000000000000005b_INDEX_6 |   110 |
   |       67 | stu/FTS_0000000000000042_BEING_DELETED            |   100 |
   |       68 | stu/FTS_0000000000000042_BEING_DELETED_CACHE      |   101 |
   |       69 | stu/FTS_0000000000000042_CONFIG                   |   102 |
   |       70 | stu/FTS_0000000000000042_DELETED                  |   103 |
   |       71 | stu/FTS_0000000000000042_DELETED_CACHE            |   104 |
   |       66 | stu/opening_lines                                 |    99 |
   +----------+---------------------------------------------------+-------+
   12 rows in set (0.01 sec)
   
   mysql> 
```

The first six index tables comprise the inverted index and are referred to as auxiliary index tables. When incoming documents are tokenized, the individual words (also referred to as “tokens”) are inserted into the index tables along with position information and an associated DOC_ID. The words are fully sorted and partitioned among the six index tables based on the character set sort weight of the word's first character.(前六个索引表组成倒排索引，称为辅助索引表。在对传入文档进行标记时，将单个单词(也称为“标记”)与位置信息和关联的DOC_ID一起插入索引表。根据单词第一个字符的字符集排序权重，将单词完全排序并在六个索引表中进行分区。)

The inverted index is partitioned into six auxiliary index tables to support parallel index creation. By default, two threads tokenize, sort, and insert words and associated data into the index tables. The number of threads that perform this work is configurable using the innodb_ft_sort_pll_degree variable. Consider increasing the number of threads when creating full-text indexes on large tables.(倒排索引被划分为六个辅助索引表，以支持并行索引创建。默认情况下，两个线程对单词和相关数据进行标记、排序和插入索引表。执行这项工作的线程数量可以使用innodb_ft_sort_pll_degree变量进行配置。在大型表上创建全文索引时，请考虑增加线程数。)

Auxiliary index table names are prefixed with fts_ and postfixed with index_#. Each auxiliary index table is associated with the indexed table by a hex value in the auxiliary index table name that matches the table_id of the indexed table. For example, the table_id of the stu/opening_lines table is 66, for which the hex value is 0x42. As shown in the preceding example, the “42” hex value appears in the names of auxiliary index tables that are associated with the test/opening_lines table.(辅助索引表名的前缀是fts_，后缀是index_#。每个辅助索引表通过与被索引表的table_id匹配的辅助索引表名中的十六进制值与被索引表相关联。例如，stu/opening_lines表的table_id为66，其十六进制值为0x42。如前面的示例所示，“42”十六进制值出现在与stu/opening_lines表相关联的辅助索引表的名称中。)
> PS: 本地测试table_id 是 66 ， 换算为十六进制为 0x42\



### 附录
#### 1. Full-Text Search Functions




---
## 参考资料
1. [14.9 Full-Text Search Functions](https://dev.mysql.com/doc/refman/8.0/en/fulltext-search.html)
2. [17.6.2.4 InnoDB Full-Text Indexes](https://dev.mysql.com/doc/refman/8.0/en/innodb-fulltext-index.html)
3. 什么是倒排索引： 倒排索引源于实际应用中需要根据属性的值来查找记录。这种索引表中的每一项都包括一个属性值和具有该属性值的各记录的地址。由于不是由记录来确定属性值，而是由属性值来确定记录的位置，因而称为倒排索引(inverted index)