# Undo Tablespaces
```txt
   参考MySQL8.0 , 5.7版本参考官方文档

   在长时间运行后，undo tablespace 中的undo logs文件可能会很大，可以创建额外的表空间来防止单个表空间变得太大。

   undo tablespaces 表空间文件超过限制就会被截断，如果在高负载时刻，会很影响性能,可以考虑手动处理

   增加undo tablespaces的数量，可以提升MySQL性能
```
Undo tablespaces contain undo logs, which are collections of records containing information about how to undo the latest change by a transaction to a clustered index record.(Undo表空间包含Undo日志，这些日志是记录的集合，其中包含有关如何撤消事务对聚集索引记录的最新更改的信息。) <sup>undo log 在MySQL5.7版本是存储在System tablespace</sup>

## Default Undo Tablespaces
wo default undo tablespaces are created when the MySQL instance is initialized. Default undo tablespaces are created at initialization time to provide a location for rollback segments that must exist before SQL statements can be accepted. A minimum of two undo tablespaces is required to support automated truncation of undo tablespaces. See [Truncating Undo Tablespaces](#truncating-undo-tablespaces). （初始化MySQL实例时不会创建默认的undo表空间。默认的undo表空间是在初始化时创建的，用于为回滚段提供一个位置，这些回滚段必须在SQL语句被接受之前存在。要支持自动截断undo表空间，至少需要两个undo表空间。）

Default undo tablespaces are created in the location defined by the innodb_undo_directory variable. If the innodb_undo_directory variable is undefined, default undo tablespaces are created in the data directory. Default undo tablespace data files are named undo_001 and undo_002. The corresponding undo tablespace names defined in the data dictionary are innodb_undo_001 and innodb_undo_002.(默认的undo表空间是在innodb_undo_directory变量定义的位置创建的。如果变量innodb_undo_directory未定义，则在data目录下创建默认的undo表空间。默认的undo表空间数据文件名为“undo_001”和“undo_002”。对应的undo表空间名称在数据字典中定义为innodb_undo_001和innodb_undo_002。)

As of MySQL 8.0.14, additional undo tablespaces can be created at runtime using SQL.(从MySQL 8.0.14开始，可以在运行时使用SQL创建额外的undo表空间。)

## Undo Tablespace Size
Prior to MySQL 8.0.23, the initial size of an undo tablespace depends on the innodb_page_size value. For the default 16KB page size, the initial undo tablespace file size is 10MiB. For 4KB, 8KB, 32KB, and 64KB page sizes, the initial undo tablespace files sizes are 7MiB, 8MiB, 20MiB, and 40MiB, respectively. As of MySQL 8.0.23, the initial undo tablespace size is normally 16MiB. The initial size may differ when a new undo tablespace is created by a truncate operation. In this case, if the file extension size is larger than 16MB, and the previous file extension occurred within the last second, the new undo tablespace is created at a quarter of the size defined by the innodb_max_undo_log_size variable.（在MySQL 8.0.23之前，undo表空间的初始大小取决于innodb_page_size的值。对于默认的16KB页面大小，初始undo表空间文件大小为10MiB。对于4KB、8KB、32KB和64KB的页面大小，undo表空间文件的初始大小分别为7MiB、8MiB、20MiB和40MiB。从MySQL 8.0.23开始，初始的undo表空间大小通常是16MiB。当截断操作创建新的undo表空间时，初始大小可能不同。在这种情况下，如果文件扩展名大小大于16MB，并且前一个文件扩展名是在最后一秒内发生的，那么新的undo表空间将以innodb_max_undo_log_size变量定义的大小的四分之一创建。）

Prior to MySQL 8.0.23, an undo tablespace is extended four extents at a time. From MySQL 8.0.23, an undo tablespace is extended by a minimum of 16MB. To handle aggressive growth, the file extension size is doubled if the previous file extension happened less than 0.1 seconds earlier. Doubling of the extension size can occur multiple times to a maximum of 256MB. If the previous file extension occurred more than 0.1 seconds earlier, the extension size is reduced by half, which can also occur multiple times, to a minimum of 16MB. If the AUTOEXTEND_SIZE option is defined for an undo tablespace, it is extended by the greater of the AUTOEXTEND_SIZE setting and the extension size determined by the logic described above. （在MySQL 8.0.23之前，undo表空间一次扩展4个区段。从MySQL 8.0.23开始，undo表空间至少扩展了16MB。为了处理快速增长，如果前一个文件扩展名发生的时间少于0.1秒，则文件扩展名大小将加倍。扩展大小可以翻倍多次，最大不超过256MB。如果前一个文件扩展名早出现0.1秒以上，则扩展名大小将减少一半(也可以出现多次)，最小为16MB。如果为撤销表空间定义了AUTOEXTEND_SIZE选项，则根据AUTOEXTEND_SIZE设置和上述逻辑确定的扩展大小中较大的值对其进行扩展。）

## Adding Undo Tablespaces
Because undo logs can become large during long-running transactions, creating additional undo tablespaces can help prevent individual undo tablespaces from becoming too large.  As of MySQL 8.0.14, additional undo tablespaces can be created at runtime using CREATE UNDO TABLESPACE syntax.（因为在长时间运行的事务期间，undo logs 可能会变得很大，所以创建额外的undo tablespaces可以帮助防止单个undo tablespaces变得太大。从MySQL 8.0.14开始，可以在运行时使用CREATE undo TABLESPACE语法创建额外的undo表空间。）
```txt
   CREATE UNDO TABLESPACE tablespace_name ADD DATAFILE 'file_name.ibu';
```

The undo tablespace file name must have an .ibu extension. It is not permitted to specify a relative path when defining the undo tablespace file name. A fully qualified path is permitted, but the path must be known to InnoDB. Known paths are those defined by the innodb_directories variable. Unique undo tablespace file names are recommended to avoid potential file name conflicts when moving or cloning data.(undo表空间文件名必须以.ibu为扩展名。在定义undo表空间文件名时，不允许指定相对路径。允许使用完全限定的路径，但是该路径必须为InnoDB所知。已知路径是由innodb_directories变量定义的路径。建议使用唯一的undo表空间文件名，以避免在移动或克隆数据时可能发生的文件名冲突。)

In a replication environment, the source and each replica must have its own undo tablespace file directory. Replicating the creation of an undo tablespace file to a common directory would cause a file name conflict.(在复制环境中，源和每个副本必须有自己的undo表空间文件目录。将undo表空间文件的创建复制到公共目录将导致文件名冲突。)

At startup, directories defined by the innodb_directories variable are scanned for undo tablespace files. (The scan also traverses subdirectories.) Directories defined by the innodb_data_home_dir, innodb_undo_directory, and datadir variables are automatically appended to the innodb_directories value regardless of whether the innodb_directories variable is defined explicitly. An undo tablespace can therefore reside in paths defined by any of those variables.(在启动时，innodb_directories变量定义的目录被扫描以查找undo表空间文件。(扫描还遍历子目录。)innodb_data_home_dir、innodb_undo_directory和datadir变量定义的目录，无论是否显式定义innodb_directories变量，都会自动添加到innodb_directories值中。因此，撤销表空间可以驻留在由这些变量定义的路径中。)

If the undo tablespace file name does not include a path, the undo tablespace is created in the directory defined by the innodb_undo_directory variable. If that variable is undefined, the undo tablespace is created in the data directory.(如果undo表空间文件名不包含路径，则在innodb_undo_directory变量定义的目录下创建undo表空间。如果该变量未定义，则在数据目录中创建undo表空间。)

To view undo tablespace names and paths, query INFORMATION_SCHEMA.FILES:
```sql
   SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE LIKE 'UNDO LOG';
```

A MySQL instance supports up to 127 undo tablespaces including the two default undo tablespaces created when the MySQL instance is initialized.(一个MySQL实例最多支持127个undo表空间，包括MySQL实例初始化时缺省创建的两个undo表空间。)

## Dropping Undo Tablespaces
As of MySQL 8.0.14, undo tablespaces created using CREATE UNDO TABLESPACE syntax can be dropped at runtime using DROP UNDO TABALESPACE syntax.

An undo tablespace must be empty before it can be dropped. To empty an undo tablespace, the undo tablespace must first be marked as inactive using ALTER UNDO TABLESPACE syntax so that the tablespace is no longer used for assigning rollback segments to new transactions.
```sql
   ALTER UNDO TABLESPACE tablespace_name SET INACTIVE;
```

After an undo tablespace is marked as inactive, transactions currently using rollback segments in the undo tablespace are permitted to finish, as are any transactions started before those transactions are completed. After transactions are completed, the purge system frees the rollback segments in the undo tablespace, and the undo tablespace is truncated to its initial size. (The same process is used when truncating undo tablespaces. See Truncating Undo Tablespaces.) Once the undo tablespace is empty, it can be dropped.(在将undo表空间标记为非活动后，允许当前使用undo表空间中的回滚段的事务完成，在这些事务完成之前启动的任何事务也是如此。事务完成后，清除系统释放undo表空间中的回滚段，undo表空间被截断到初始大小。一旦undo表空间为空，就可以删除它)
```sql
   DROP UNDO TABLESPACE tablespace_name;
```

The state of an undo tablespace can be monitored by querying the Information Schema INNODB_TABLESPACES table.
```sql
   SELECT NAME, STATE FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME LIKE 'tablespace_name';
```

An inactive state indicates that rollback segments in an undo tablespace are no longer used by new transactions. An empty state indicates that an undo tablespace is empty and ready to be dropped, or ready to be made active again using an ALTER UNDO TABLESPACE tablespace_name SET ACTIVE statement. Attempting to drop an undo tablespace that is not empty returns an error.(非活动状态表示undo表空间中的回滚段不再被新事务使用。空状态表示undo表空间是空的，准备被删除，或者准备使用ALTER undo tablespace tablespace_name SET active语句重新激活。尝试删除非空的撤销表空间将返回错误。)

The default undo tablespaces (innodb_undo_001 and innodb_undo_002) created when the MySQL instance is initialized cannot be dropped. They can, however, be made inactive using an ALTER UNDO TABLESPACE tablespace_name SET INACTIVE statement. Before a default undo tablespace can be made inactive, there must be an undo tablespace to take its place. A minimum of two active undo tablespaces are required at all times to support automated truncation of undo tablespaces.(MySQL实例初始化时创建的默认undo表空间(innodb_undo_001和innodb_undo_002)不能被删除。但是，可以使用ALTER UNDO TABLESPACE tablespace_name SET inactive语句使它们处于非活动状态。在默认的撤销表空间处于非活动状态之前，必须有一个撤销表空间来代替它。为了支持自动截断undo表空间，在任何时候都需要至少两个活动的undo表空间。)

## Moving Undo Tablespaces
Undo tablespaces created with CREATE UNDO TABLESPACE syntax can be moved while the server is offline to any known directory. Known directories are those defined by the innodb_directories variable. Directories defined by innodb_data_home_dir, innodb_undo_directory, and datadir are automatically appended to the innodb_directories value regardless of whether the innodb_directories variable is defined explicitly. Those directories and their subdirectories are scanned at startup for undo tablespaces files. An undo tablespace file moved to any of those directories is discovered at startup and assumed to be the undo tablespace that was moved.(使用CREATE Undo TABLESPACE语法创建的Undo表空间可以在服务器脱机时移动到任何已知目录。已知目录是由innodb_directories变量定义的目录。innodb_data_home_dir、innodb_undo_directory和datadir定义的目录，无论是否显式定义了innodb_directories变量，都会自动添加到innodb_directories的值中。在启动时扫描这些目录及其子目录以查找undo表空间文件。在启动时发现移动到这些目录中的撤销表空间文件，并假定它是被移动的撤销表空间。)

The default undo tablespaces (innodb_undo_001 and innodb_undo_002) created when the MySQL instance is initialized must reside in the directory defined by the innodb_undo_directory variable. If the innodb_undo_directory variable is undefined, default undo tablespaces reside in the data directory. If default undo tablespaces are moved while the server is offline, the server must be started with the innodb_undo_directory variable configured to the new directory.(MySQL实例初始化时创建的默认undo表空间(innodb_undo_001和innodb_undo_002)必须位于由innodb_undo_directory变量定义的目录中。如果变量innodb_undo_directory未定义，默认的undo表空间驻留在data目录中。如果在服务器离线时移动了默认的undo表空间，则必须在启动服务器时将innodb_undo_directory变量配置为新目录。)

The I/O patterns for undo logs make undo tablespaces good candidates for SSD storage.(撤销日志的I/O模式使撤销表空间成为SSD存储的理想选择。)

## Configuring the Number of Rollback Segments
The innodb_rollback_segments variable defines the number of rollback segments allocated to each undo tablespace and to the global temporary tablespace. The innodb_rollback_segments variable can be configured at startup or while the server is running.(innodb_rollback_segments变量定义了分配给每个undo表空间和全局临时表空间的回滚段的数量。innodb_rollback_segments变量可以在启动时或服务器运行时配置。)

The default setting for innodb_rollback_segments is 128, which is also the maximum value. For information about the number of transactions that a rollback segment supports,see [undo logs](../../003.MySQL事务/006.InnoDB事务日志/001.undo.log.md)(innodb_rollback_segments的默认值是128，这也是最大值。)

## Truncating Undo Tablespaces
There are two methods of truncating undo tablespaces, which can be used individually or in combination to manage undo tablespace size. One method is automated, enabled using configuration variables. The other method is manual, performed using SQL statements.(有两种截断undo表空间的方法，可以单独使用或组合使用来管理undo表空间大小。一种方法是自动化的，使用配置变量启用。另一种方法是手动的，使用SQL语句执行。)

The automated method does not require monitoring undo tablespace size and, once enabled, it performs deactivation, truncation, and reactivation of undo tablespaces without manual intervention. The manual truncation method may be preferable if you want to control when undo tablespaces are taken offline for truncation. For example, you may want to avoid truncating undo tablespaces during peak workload times.(自动化方法不需要监视撤消表空间大小，并且一旦启用，它将执行撤消表空间的去激活、截断和重新激活，而无需人工干预。如果您希望控制何时将undo表空间脱机进行截断，那么手动截断方法可能更可取。例如，您可能希望避免在工作负载高峰期间截断undo表空间。)
### Automated Truncation
Automated truncation of undo tablespaces requires a minimum of two active undo tablespaces, which ensures that one undo tablespace remains active while the other is taken offline to be truncated. By default, two undo tablespaces are created when the MySQL instance is initialized.(自动截断undo表空间需要至少两个活动的undo表空间，这可以确保一个undo表空间保持活动，而另一个则脱机进行截断。默认情况下，初始化MySQL实例时会创建两个undo表空间。)

To have undo tablespaces automatically truncated, enable the innodb_undo_log_truncate variable. For example:(要自动截断undo表空间，可以启用innodb_undo_log_truncate变量。例如:)
```txt
    mysql> SET GLOBAL innodb_undo_log_truncate=ON;
```

When the innodb_undo_log_truncate variable is enabled, undo tablespaces that exceed the size limit defined by the innodb_max_undo_log_size variable are subject to truncation. The innodb_max_undo_log_size variable is dynamic and has a default value of 1073741824 bytes (1024 MiB).(当启用innodb_undo_log_truncate变量时，超过innodb_max_undo_log_size变量定义的大小限制的undo表空间将被截断。innodb_max_undo_log_size是动态变量，默认值为1073741824字节(1024 MiB)。)

When the innodb_undo_log_truncate variable is enabled:
1. Default and user-defined undo tablespaces that exceed the innodb_max_undo_log_size setting are marked for truncation. Selection of an undo tablespace for truncation is performed in a circular fashion to avoid truncating the same undo tablespace each time.(默认的和用户定义的undo表空间超过innodb_max_undo_log_size设置将被标记为截断。撤消表空间的选择以循环方式执行，以避免每次都截断相同的撤消表空间。)
2. Rollback segments residing in the selected undo tablespace are made inactive so that they are not assigned to new transactions. Existing transactions that are currently using rollback segments are permitted to finish.(位于所选undo表空间中的回滚段处于非活动状态，因此不会将它们分配给新事务。允许当前正在使用回滚段的现有事务完成。)
3. The purge system empties rollback segments by freeing undo logs that are no longer in use.
4. After all rollback segments in the undo tablespace are freed, the truncate operation runs and truncates the undo tablespace to its initial size.
   - The size of an undo tablespace after a truncate operation may be larger than the initial size due to immediate use following the completion of the operation.(由于截断操作完成后立即使用undo表空间，因此截断操作后的undo表空间大小可能比初始大小大。)
   - The innodb_undo_directory variable defines the location of default undo tablespace files. If the innodb_undo_directory variable is undefined, default undo tablespaces reside in the data directory. The location of all undo tablespace files including user-defined undo tablespaces created using CREATE UNDO TABLESPACE syntax can be determined by querying the Information Schema FILES table:(innodb_undo_directory变量定义默认undo表空间文件的位置。如果变量innodb_undo_directory未定义，默认的undo表空间驻留在data目录中。所有undo表空间文件的位置，包括使用CREATE undo tablespace语法创建的用户定义的undo表空间，都可以通过查询Information Schema files表来确定:)
     ```txt
       SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES WHERE FILE_TYPE LIKE 'UNDO LOG';
     ```
5. Rollback segments are reactivated so that they can be assigned to new transactions.(回滚段被重新激活，以便将它们分配给新的事务。)

### Manual Truncation
Manual truncation of undo tablespaces requires a minimum of three active undo tablespaces. Two active undo tablespaces are required at all times to support the possibility that automated truncation is enabled. A minimum of three undo tablespaces satisfies this requirement while permitting an undo tablespace to be taken offline manually.(手动截断undo表空间需要至少三个活动的undo表空间。任何时候都需要两个活动的undo表空间来支持自动截断的可能性。至少有三个undo表空间满足此要求，同时允许手动使undo表空间脱机。)

To manually initiate truncation of an undo tablespace, deactivate the undo tablespace by issuing the following statement:(要手动启动undo表空间的截断，请执行以下命令去激活undo表空间:)
```txt
   ALTER UNDO TABLESPACE tablespace_name SET INACTIVE;
```
After the undo tablespace is marked as inactive, transactions currently using rollback segments in the undo tablespace are permitted to finish, as are any transactions started before those transactions are completed. After transactions are completed, the purge system frees the rollback segments in the undo tablespace, the undo tablespace is truncated to its initial size, and the undo tablespace state changes from inactive to empty.(在undo表空间被标记为非活动后，允许当前使用undo表空间中的回滚段的事务完成，在这些事务完成之前启动的任何事务也是如此。事务完成后，清除系统释放undo表空间中的回滚段，undo表空间被截断为初始大小，undo表空间状态从inactive变为empty。)

To check the state of an undo tablespace, query the Information Schema INNODB_TABLESPACES table.(要查看undo表空间的状态，请查询信息模式INNODB_TABLESPACES表。)
```txt
   SELECT NAME, STATE FROM INFORMATION_SCHEMA.INNODB_TABLESPACES WHERE NAME LIKE 'tablespace_name';
```

Once the undo tablespace is in an empty state, it can be reactivated by issuing the following statement:
```txt
   ALTER UNDO TABLESPACE tablespace_name SET ACTIVE;
```

### Expediting Automated Truncation of Undo Tablespaces(加速撤销表空间的自动截断)
The purge thread is responsible for emptying and truncating undo tablespaces. By default, the purge thread looks for undo tablespaces to truncate once every 128 times that purge is invoked. The frequency with which the purge thread looks for undo tablespaces to truncate is controlled by the innodb_purge_rseg_truncate_frequency variable, which has a default setting of 128.(清除线程负责清空和截断undo表空间。默认情况下，清除线程每128次调用清除一次查找要截断的undo表空间。清除线程查找要截断的undo表空间的频率由innodb_purge_rseg_truncate_frequency变量控制，该变量的默认设置为128。)
```txt
   mysql> SELECT @@innodb_purge_rseg_truncate_frequency;
   +----------------------------------------+
   | @@innodb_purge_rseg_truncate_frequency |
   +----------------------------------------+
   |                                    128 |
   +----------------------------------------+
```
To increase the frequency, decrease the innodb_purge_rseg_truncate_frequency setting. For example, to have the purge thread look for undo tablespaces once every 32 times that purge is invoked, set innodb_purge_rseg_truncate_frequency to 32.(要增加频率，请减小innodb_purge_rseg_truncate_frequency设置。例如，要让清理线程每32次调用清理一次查找undo表空间，可以将innodb_purge_rseg_truncate_frequency设置为32。)
```txt
   mysql> SET GLOBAL innodb_purge_rseg_truncate_frequency=32;
```

### Performance Impact of Truncating Undo Tablespace Files（截断Undo表空间文件对性能的影响）
When an undo tablespace is truncated, the rollback segments in the undo tablespace are deactivated. The active rollback segments in other undo tablespaces assume responsibility for the entire system load, which may result in a slight performance degradation. The extent to which performance is affected depends on a number of factors:（当undo表空间被截断时，undo表空间中的回滚段将失效。其他undo表空间中的活动回滚段负责整个系统负载，这可能会导致性能略有下降。性能受影响的程度取决于以下几个因素:）
- Number of undo tablespaces
- Number of undo logs
- Undo tablespace size
- Speed of the I/O subsystem
- Existing long running transactions
- System load

The easiest way to avoid the potential performance impact is to increase the number of undo tablespaces.(避免潜在性能影响的最简单方法是增加undo表空间的数量。)


### Monitoring Undo Tablespace Truncation
As of MySQL 8.0.16, undo and purge subsystem counters are provided for monitoring background activities associated with undo log truncation. For counter names and descriptions, query the Information Schema INNODB_METRICS table.(从MySQL 8.0.16开始，提供了undo和purge subsystem计数器来监视与撤消日志截断相关的后台活动。有关计数器名称和描述，请查询信息模式INNODB_METRICS表。)
```txt
   SELECT NAME, SUBSYSTEM, COMMENT FROM INFORMATION_SCHEMA.INNODB_METRICS WHERE NAME LIKE '%truncate%';
```

### Undo Tablespace Truncation Limit
As of MySQL 8.0.21, the number of truncate operations on the same undo tablespace between checkpoints is limited to 64. The limit prevents potential issues caused by an excessive number of undo tablespace truncate operations, which can occur if innodb_max_undo_log_size is set too low on a busy system, for example. If the limit is exceeded, an undo tablespace can still be made inactive, but it is not truncated until after the next checkpoint. the limit was raised from 64 to 50,000 in MySQL 8.0.22.（从MySQL 8.0.21开始，在检查点之间对同一撤消表空间的截断操作数量限制为64。该限制可防止由于撤消表空间截断操作次数过多而导致的潜在问题，例如，如果在繁忙的系统上将innodb_max_undo_log_size设置得过低，则可能会出现这种情况。如果超过了限制，撤消表空间仍然可以处于非活动状态，但直到下一个检查点之后才会被截断。MySQL 8.0.22将限制从64提高到50000。）

### Undo Tablespace Truncation Recovery
An undo tablespace truncate operation creates a temporary undo_space_number_trunc.log file in the server log directory. That log directory is defined by innodb_log_group_home_dir. If a system failure occurs during the truncate operation, the temporary log file permits the startup process to identify undo tablespaces that were being truncated and to continue the operation.（undo表空间截断操作会在服务器日志目录下创建一个临时文件undo_space_number_trunc.log。该日志目录由innodb_log_group_home_dir定义。如果在截断操作期间发生系统故障，则临时日志文件允许启动进程识别被截断的undo表空间并继续操作。）


### Undo Tablespace Status Variables
The following status variables permit tracking the total number of undo tablespaces, implicit (InnoDB-created) undo tablespaces, explicit (user-created) undo tablespaces, and the number of active undo tablespaces:(以下状态变量允许跟踪undo表空间的总数，隐式(innodb创建的)undo表空间，显式(用户创建的)undo表空间，以及活动的undo表空间的数量:)
```txt
  mysql> SHOW STATUS LIKE 'Innodb_undo_tablespaces%';
  +----------------------------------+-------+
  | Variable_name                    | Value |
  +----------------------------------+-------+
  | Innodb_undo_tablespaces_total    | 2     |
  | Innodb_undo_tablespaces_implicit | 2     |
  | Innodb_undo_tablespaces_explicit | 0     |
  | Innodb_undo_tablespaces_active   | 2     |
  +----------------------------------+-------+
```

## 参考资料
1. [Undo Tablespaces](https://dev.mysql.com/doc/refman/8.0/en/innodb-undo-tablespaces.html)