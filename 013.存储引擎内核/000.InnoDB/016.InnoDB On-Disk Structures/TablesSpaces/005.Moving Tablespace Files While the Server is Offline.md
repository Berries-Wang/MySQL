# Moving Tablespace Files While the Server is Offline
## 摘要

## 文档
The innodb_directories variable, which defines directories to scan at startup for tablespace files, supports moving or restoring tablespace files to a new location while the server is offline. During startup, discovered tablespace files are used instead those referenced in the data dictionary, and the data dictionary is updated to reference the relocated files. If duplicate tablespace files are discovered by the scan, startup fails with an error indicating that multiple files were found for the same tablespace ID.（innodb_directories变量定义了在启动时扫描表空间文件的目录，支持在服务器离线时将表空间文件移动或恢复到新位置。在启动期间，将使用发现的表空间文件来代替数据字典中引用的那些文件，并更新数据字典以引用重新定位的文件。如果通过扫描发现重复的表空间文件，则启动失败，错误提示为相同的表空间ID找到多个文件。）

The directories defined by the innodb_data_home_dir, innodb_undo_directory, and datadir variables are automatically appended to the innodb_directories argument value. These directories are scanned at startup regardless of whether an innodb_directories setting is specified explicitly. The implicit addition of these directories permits moving system tablespace files, the data directory, or undo tablespace files without configuring the innodb_directories setting. However, settings must be updated when directories change. For example, after relocating the data directory, you must update the --datadir setting before restarting the server.（由innodb_data_home_dir、innodb_undo_directory和datadir变量定义的目录会自动添加到innodb_directories参数值中。这些目录在启动时都会被扫描，不管innodb_directories设置是否被明确指定。这些目录的隐式添加允许移动系统表空间文件、数据目录或undo表空间文件，而无需配置innodb_directories设置。但是，当目录更改时，必须更新设置。例如，在重新定位数据目录后，必须在重新启动服务器之前更新——datadir设置。）

The innodb_directories variable can be specified in a startup command or MySQL option file. Quotes are used around the argument value because a semicolon (;) is interpreted as a special character by some command interpreters. (Unix shells treat it as a command terminator, for example.)（innodb_directories变量可以在启动命令或MySQL选项文件中指定。因为分号(;)被某些命令解释器解释为特殊字符，所以参数值周围使用引号。(例如，Unix shell将其视为命令终止符。)）

Startup command:
```shell
     > mysqld --innodb-directories="directory_path_1;directory_path_2"
```

MySQL option file:
```txt
   [mysqld]
   innodb_directories="directory_path_1;directory_path_2"
```

The following procedure is applicable to moving individual file-per-table and general tablespace files, system tablespace files, undo tablespace files, or the data directory. Before moving files or directories, review the usage notes that follow.(下面的过程适用于移动单个表文件和一般表空间文件、系统表空间文件、undo表空间文件或数据目录。在移动文件或目录之前，请查看下面的使用说明。)
1. Stop the server.
2. Move the tablespace files or directories to the desired location.
3. Make the new directory known to InnoDB.
   + If moving individual file-per-table or general tablespace files, add unknown directories to the innodb_directories value.
     - The directories defined by the innodb_data_home_dir, innodb_undo_directory, and datadir variables are automatically appended to the innodb_directories argument value, so you need not specify these.
     - A file-per-table tablespace file can only be moved to a directory with same name as the schema. For example, if the actor table belongs to the sakila schema, then the actor.ibd data file can only be moved to a directory named sakila.(file-per-table 表空间文件只能移动到与Schema同名的目录中。例如，如果actor表属于sakila模式，那么actor。Ibd数据文件只能移动到名为sakila的目录下。)
     - General tablespace files cannot be moved to the data directory or a subdirectory of the data directory.(普通表空间文件不能移动到data目录或data目录的子目录。)
   + If moving system tablespace files, undo tablespaces, or the data directory, update the innodb_data_home_dir, innodb_undo_directory, and datadir settings, as necessary.（如果移动系统表空间文件、undo表空间或者数据目录，需要更新innodb_data_home_dir、innodb_undo_directory和datadir设置。）
4. Restart the server

### Usage Notes
- Wildcard expressions cannot be used in the innodb_directories argument value.（通配符表达式不能用于innodb_directories参数值。）
- The innodb_directories scan also traverses subdirectories of specified directories.  Duplicate directories and subdirectories are discarded from the list of directories to be scanned.（innodb_directories扫描还会遍历指定目录的子目录。从需要扫描的目录列表中删除重复的目录和子目录。）
- innodb_directories supports moving InnoDB tablespace files.  Moving files that belong to a storage engine other than InnoDB is not supported.  This restriction also applies when moving the entire data directory.（innodb_directories支持移动InnoDB表空间文件。不支持移动属于非InnoDB存储引擎的文件。这个限制同样适用于移动整个数据目录）
- innodb_directories supports renaming of tablespace files when moving files to a scanned directory.  It also supports moving tablespaces files to other supported operating systems.（Innodb_directories支持表空间文件的重命名，当移动文件到扫描目录。它还支持将表空间文件移动到其他支持的操作系统。）
- When moving tablespace files to a different operating system, ensure that tablespace file names do not include prohibited characters or characters with a special meaning on the destination system.（将表空间文件移动到其他操作系统时，请确保表空间文件名中不包含目标系统上禁止使用的字符或具有特殊含义的字符。）
- When moving a data directory from a Windows operating system to a Linux operating system, modify the binary log file paths in the binary log index file to use backward slashes instead of forward slashes.  By default, the binary log index file has the same base name as the binary log file, with the extension '.index'.  The location of the binary log index file is defined by --log-bin.  The default location is the data directory.（将数据目录从Windows操作系统迁移到Linux操作系统时，需要修改二进制日志索引文件中的二进制日志文件路径，使用反斜杠代替正斜杠。默认情况下，二进制日志索引文件具有与二进制日志文件相同的基本名称，扩展名为'.index'。二进制日志索引文件的位置由--log-bin定义。默认位置是数据目录。）
- If moving tablespace files to a different operating system introduces cross-platform replication, it is the database administrator's responsibility to ensure proper replication of DDL statements that contain platform-specific directories.  Statements that permit specifying directories include CREATE TABLE ...  DATA DIRECTORY and CREATE TABLESPACE ...  ADD DATAFILE.（如果将表空间文件移动到不同的操作系统会引入跨平台复制，那么数据库管理员就有责任确保适当复制包含特定于平台的目录的DDL语句。允许指定目录的语句包括 CREATE TABLESPACE ...  ADD DATAFILE.。）
- Add the directories of file-per-table and general tablespaces created with an absolute path or in a location outside of the data directory to the innodb_directories setting.  Otherwise, InnoDB is not able to locate the files during recovery.  For related information, see [Tablespace Discovery During Crash Recovery](https://dev.mysql.com/doc/refman/8.4/en/innodb-recovery.html#innodb-recovery-tablespace-discovery).（将使用绝对路径或在数据目录之外的位置创建的file-per-table和常规表空间目录添加到innodb_directories设置中。否则，InnoDB在恢复过程中无法定位文件。)


To view tablespace file locations, query the Information Schema FILES table:
```txt
    mysql> SELECT TABLESPACE_NAME, FILE_NAME FROM INFORMATION_SCHEMA.FILES \G
```

### 测试一下

---

## 参考资料
1. [https://dev.mysql.com/doc/refman/8.4/en/innodb-moving-data-files-offline.html](https://dev.mysql.com/doc/refman/8.4/en/innodb-moving-data-files-offline.html)


