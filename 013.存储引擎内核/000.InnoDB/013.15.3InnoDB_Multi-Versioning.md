# 15.3 InnoDB Multi-Versioning
## 简介
&nbsp;&nbsp;InnoDB是一个多版本存储引擎，他保存着已更新行的历史版本信息,以支持并发和回滚的事务特性。这些信息存储在undo表空间中的数据结构成为回滚段。请参考:[undo 表空间](https://dev.mysql.com/doc/refman/8.1/en/innodb-undo-tablespaces.html)。InnoDB使用回滚段中的信息来执行实物回滚所需的undo操作。他还使用这些信息来构建行的早期版本，以实现的一致性的读取，请参考:[一致性非锁定读](../../003.MySQL事务/005.一致性非锁定读.md)。

### 内部实现
&nbsp;&nbsp;在内部，InnoDB在数据库存储的每一行添加了三个字段:
1. DB_TRX_ID: 6字节，插入或更新该行的最后一个事务的事务标识符。此外，删除在内部被视为更新，其中设置行中的特殊位以将其标记为已删除。
2. DB_ROLL_PTR: 回滚指针，7字节，指向写入到回滚段的undo log记录。此外，删除在内部被视为更新，行中的一个特殊位被设置就标识着被删除。
3. DB_ROW_ID: 行ID，6字节。随着新插入行而单调递增。如果InnoDB自动生成聚集索引，则索引包含行ID值，否则，DB_ROW_ID 不会出现在任何索引中。

&nbsp;&nbsp;回滚段中的undo log 被区分为insert undo log 和 update undo log。
- Insert undo log 只用于事务回滚，在事务提交后可以被立即丢弃。
- update undo log : update undo log 也被用于一致性读，但只有在不存在InnoDB已为其分配快照事务之后，才能丢弃这些日志。在一致性读取中，该快照可能需要update undo log 中的信息来构建数据库行的早期版本。

&nbsp;&nbsp;建议定期提交事务，包括发起只发出一致性读的事务。否则，InnoDB无法丢弃update undo log 中的数据，回滚段可能会变得太大，填满undo 表空间。

&nbsp;&nbsp;回滚段中undo log 记录的物理大小，一般小于相应插入或更新的行。你可以使用这些信息来计算回滚段所需要的空间。

&nbsp;&nbsp;在InnoDb多版本方案中，当你使用SQL语句删除一行时，他不会立即从数据库中物理删除。InnoDB只会在丢弃因删除该行而写入的update undo log 时才会被物理删除。这种操作被称为purge，速度非常快，通常与执行删除操作的SQL语句所花费的时间顺序相同。

&nbsp;&nbsp;如果在表中以大约相同的速率以小批量插入和删除行，则清除线程可能会开始滞后，并且由于所有“死行”，表可能会变得越来越大，从而使所有内容都绑定到磁盘，并且速度非常慢。在这种情况下，通过调优innodb_max_purge_lag系统变量来限制新行操作，并为清除线程分配更多资源。


## Multi-Versioning and Secondary Indexes
&nbsp;&nbsp;InnoDB区别对待二级索引和聚簇索引。聚簇索引中的记录就地更新，其隐藏的系统列指向undo log , 可从中重建早期的行数据。与聚簇索引不同，辅助索引（二级索引）不包含隐藏的系统列，也不会就地更新。

&nbsp;&nbsp;当二级索引列更新时，旧的二级索引记录被标记删除，新的记录被插入，被标记删除的记录最终被删除。当二级索引记录被标记删除或被一个更新的事务更新时，InnoDB在聚簇索引中查找该数据库记录。在聚簇索引中，检查记录的DB_TRX_ID，如果在读取事务后修改了记录，则从undo log 日志中检索记录的正确版本。

&nbsp;&nbsp;如果二级索引记录被标记为删除，或者二级索引页被较新的事务更新，则不使用覆盖索引技术。InnoDB不是从索引结构返回值，而是在聚集索引中查找记录

&nbsp;&nbsp;但是，如果启用了索引条件下推(ICP)优化，并且只能使用索引中的字段来评估部分WHERE条件，MySQL服务器仍然会将这部分WHERE条件下推到使用索引进行评估的存储引擎。如果没有找到匹配的记录，则聚集索引查找


---

## 参考资料
- [15.3 InnoDB Multi-Versioning](https://dev.mysql.com/doc/refman/8.1/en/innodb-multi-versioning.html)
- [003.MySQL事务/002.InnoDB之多版本并发控制-MVCC.md](../../003.MySQL事务/002.InnoDB之多版本并发控制-MVCC.md)
- [003.MySQL事务/006.InnoDB事务日志/001.undo.log.md](../../003.MySQL事务/006.InnoDB事务日志/001.undo.log.md)