# Online DDL
&nbsp;&nbsp;MySQL5.6允许辅助索引创建的同时，还允许其他 INSERT,UPDATE,DELETE这类DML操作，这极大提高了MySQL在生产环境的可用性。

&nbsp;&nbsp;不仅仅是辅助索引，如下几类DDL操作都可以通过在线的方式进行操作:
1. 辅助索引的创建和删除
2. 改变自增长值
3. 添加或者删除外检约束
4. 列的重命名
5. ....更多操作，而非仅此而已(参考官方文档)


## 值解析
```txt
    ALTER TABLE tbl_name MODIFY COLUMN column_name data_type NULL, ALGORITHM=INPLACE, LOCK=NONE;

    # ALGORITHM 可选：
    ## | COPY |表示按照MySQL5.1版本之前的工作模式，即创建临时表的方式|
    ## | INPLACE |表示索引创建或删除不需要创建临时表|
    ## | DEFAULT |表示根据参数old_alter_table来判断是通过INPLACE 还是 COPY 的算法，该参数默认值为OFF,即采用INPLACE算法|

    # LOCK 可选
    ## |NONE| 不加任何锁 |
    ## |SHARE|对目标表加上S锁|
    ## |EXCLUSIVE|对目标表添加X锁|
    ## |DEFAULT|会通过判断事务的最大并发性来判断执行DDL的模式,选择的顺序: NONE - > SHARE -> EXCLUSIVE,判断当前操作是否可以使用该模式。若可以，则是用该模式；反之，判断下一个|


    # Oneline DDL 工作方式
    ## InnoDB存储引擎实现Online DDL的原理是在执行创建或删除操作的同时，将INSERT,UPDATE,DELETE这类DML操作日志写入到一个缓存中。待完成索引的创建后再将重做引用到表上，以此达到数据的一致性。
    ## 该缓存大小由innodb_online_alter_log_max_size 控制，默认值为128MB。如果日志超过这个阈值，则会报错。

    # 需要考虑的问题
    ## 1. 磁盘空间的考虑: 当onlineDDL使用创建临时表的方式处理时
       ALTER TABLE tbl_name CHANGE c1 c1 BIGINT, ALGORITHM=COPY; (修改字段类型ALGORITHM只能是COPY)
    这条OnlineDDL,已创建临时表的方式修改列类型，那么在执行这条SQL时需要保证数据库有足够的磁盘空间。
```

---

## [14.13 InnoDB and Online DDL](https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl.html)
&nbsp;&nbsp;Online DDL操作
### [14.13.1 Online DDL Operations](https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html)
&nbsp;&nbsp;该文档说明了Online DDL支持的操作类型,以及具体算法.

### [14.13.2 Online DDL Performance and Concurrency](https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-performance.html)
&nbsp;&nbsp;Online DDL improves(改善) several aspects of MySQL operation:
> Online DDL 改善了MySQL操作的几个方面:

+ Applications that access the table are more responsive(adj.反应迅速的，积极反应的；反应热烈的，热情的；回应的，回答的；) because queries and DML operations on the table can proceed(v.开始行动，开展；) while the DDL operation is in progress. Reduced locking and waiting for MySQL server resources leads to greater scalability(n.可扩展性；可伸缩性；可量测性), even for operations that are not involved(adj.复杂的;v.牵涉，包含) in the DDL operation.
> 在DDL操作执行的时候，允许查询和DML操作执行，减少锁表和等待以获取更好地性能。即使是DDL操作中没有涉及的操作

+ In-place operations avoid the disk I/O and CPU cycles associated with the table-copy method, which minimizes(把……减至最低数量) overall(总的;全面的;) load on the database. Minimizing load helps maintain(v.保持，维持；维修，保养；断言) good performance and high throughput(n.（某一时期内的）生产量，接待人数，吞吐量) during the DDL operation.
> 与表复制方法相比，In-place 操作节省了I/O和CPU周期，将数据库总的负载减到最小。降低负载有助于保持数据库的高性能和高吞吐率。

+ In-place operations read less data into the buffer pool than the table-copy operations, which reduces purging of frequently accessed data from memory. Purging of frequently accessed data can cause a temporary performance dip(下降;下沉;降低;) after a DDL operation.
> 相比于表复制的方式，In-place 操作读取少量的数据到buffer pool，它减少了从内存中清除频繁访问的数据。在DDL操作后清理频繁访问的数据会临时降低性能。

####  The LOCK clause(从句，分句；)
&nbsp;&nbsp;By default, MySQL uses as little locking as possible during a DDL operation. The LOCK clause can be specified to enforce(v.实施;执行;强迫;) more restrictive(adj.限制的;约束的;) locking, if required. If the LOCK clause specifies a less restrictive level of locking than is permitted(v.允许;批准) for a particular(adj.特定的;格外的;n.一点;一个细节;详情;详细资料) DDL operation, the statement fails with an error. LOCK clauses are described below, in order of least to most restrictive:
> 默认情况下，在DDL执行期间，尽可能使用少的锁。如果需要，可以指定LOCK子句来强制更严格的锁定。如果LOCK子句指定的锁级别低于特定DDL操作锁允许的锁级别，则语句将失败并出错。下面描述了LOCK子句，从最少到最严格的顺序

>> 一些DDL操作，只能使用其中一个级别.

##### LOCK=NONE
&nbsp;&nbsp;Permits concurrent queries and DML.
> 允许并发的查询和DML

&nbsp;&nbsp;For example, use this clause for tables involving(v.涉及;包括;) customer signups(n.注册（signup 的复数）) or purchases, to avoid making the tables unavailable during lengthy(漫长的;长时间的;) DDL operations.
> 例如，对于涉及客户注册或购买的表使用此子句，以避免在漫长的的DDL操作期间使表不可用。

##### LOCK=SHARED
&nbsp;&nbsp;Permits concurrent queries but blocks DML.
> 允许并发查询但阻塞DML操作

&nbsp;&nbsp;For example, use this clause on data warehouse tables, where you can delay data load operations until the DDL operation is finished, but queries cannot be delayed for long periods(n.周期).
> 例如，在数据仓库表上使用这个子句，可以延迟数据加载操作，直到DDL操作完成，但是查询不能长时间延迟

##### LOCK=DEFAULT
&nbsp;&nbsp;Permits as much concurrency(并发性;同时发生;) as possible (concurrent queries, DML, or both). Omitting(省略) the LOCK clause is the same as specifying LOCK=DEFAULT.
> 允许尽可能多的并发(并发查询或DML或全部)。省略LOCK子句和指定LOCK=DEFAULT一样.

&nbsp;&nbsp;Use this clause when you know that the default locking level of the DDL statement does not cause availability(n.可用性，可得性) problems for the table.
> 当你知晓DDL语句默认的锁级别不会造成该表可用性问题的时候使用该子句。

##### LOCK=EXCLUSIVE
&nbsp;&nbsp;Blocks concurrent queries and DML.
> 阻塞并发查询和DML

&nbsp;&nbsp;Use this clause if the primary concern is finishing the DDL operation in the shortest amount of time possible, and concurrent query and DML access is not necessary. You might also use this clause if the server is supposed to be idle, to avoid unexpected table accesses.
> 如果主要关注的是在尽可能短的时间内完成DDL操作，而并发查询和DML访问不是必需的，则使用此子句。如果服务器应该是空闲的，也可以使用这个子句，以避免意外的表访问。

---
#### Online DDL and Metadata Locks
&nbsp;&nbsp;Online DDL operations can be viewed as having three phases:
> DDL操作可以被看作为有三个阶段:

##### Phase 1: Initialization
&nbsp;&nbsp;In the initialization phase, the server determines how much concurrency is permitted during the operation, taking into account storage engine capabilities, operations specified in the statement, and user-specified ALGORITHM and LOCK options. During this phase, a shared upgradeable metadata lock is taken to protect the current table definition.
> 在初始化阶段，

##### Phase 2: Execution
&nbsp;&nbsp;In this phase, the statement is prepared and executed. Whether the metadata lock is upgraded to exclusive depends on the factors assessed in the initialization phase. If an exclusive metadata lock is required, it is only taken briefly during statement preparation.

##### Phase 3: Commit Table Definition
&nbsp;&nbsp;In the commit table definition phase, the metadata lock is upgraded to exclusive to evict the old table definition and commit the new one. Once granted, the duration of the exclusive metadata lock is brief.


---

## 参考资料
1. [14.13.1 Online DDL Operations](https://dev.mysql.com/doc/refman/5.7/en/innodb-online-ddl-operations.html) 
2. MySQL-5.7-Reference-Manual-14.13.1-Online-DDL-Operations.pdf (即官方文档)