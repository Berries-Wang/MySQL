# Multi-Range Read (多范围读取优化)
## 总结
1. MRR 是针对于辅助索引进行的优化技术
2. 如果查询能够使用覆盖索引，那么MRR不会带来优化的收益
3. MRR能带来优化是因为将随机I/O转换为了顺序I/O

## MRR介绍
&nbsp;&nbsp;当表很大且未存储在存储引擎的缓存中时，使用**二级索引**上的范围扫描读取行可能会导致对基表的许多随机磁盘访问。通过磁盘扫描多范围读取(MRR)优化，MySQL通过首先仅扫描索引并收集相关行的键来尝试减少范围扫描的随机磁盘访问次数。然后对键进行排序，最后使用主键的顺序从基表中检索行。即Disk-Sweep MRR的目标是减少随机磁盘访问的次数，实现对基表数据的顺序访问。

&nbsp;&nbsp;MRR优化有如下几个好处：
1. MRR使数据访问变得较为顺序。在查询辅助索引时，首先会根据得到的查询结果，按照主键进行排序，并按照主键的顺序进行书签查找。
   - 书签查找： 即通过聚集索引，然后利用聚集索引或RID定位到数据。
2. 减少缓冲池中页被替换的次数
3. 批量处理对键值的查询操作


&nbsp;&nbsp;对于InnoDB和MyISAM存储引擎的范围查询和JOIN查询操作，MRR的工作方式如下：
1. 将查询到的辅助索引键值放到一个缓存中，这时缓存中的数据是根据辅助索引键值排序的。
2. 将缓存中的键值根据RowID进行排序
3. 根据RowID的排序顺序来访问实际的数据文件。

### MRR带来的其他性能提升
#### 减少缓冲池中页被替换的次数（待理解）
&nbsp;&nbsp;InnoDB存储引擎或者MyISAM存储引擎的缓冲池不是足够大，即不能存放下一张表中的所有数据，此时频繁的离散读操作还会导致缓存中的页被替换出缓冲池，然后又不断地读入缓冲池。若是按主键顺序进行访问，则可以将此重复行为降为最低。
   - 理解:因为是顺序I/O,所以在读取数据是读取完上一页，再去读取下一页。即不用在读取第二页之后还需要将第一页替换回来

#### 先拆分查询条件，再进行数据查询（待理解）
&nbsp;&nbsp;若开启了MRR优化，优化器会先将查询条件进行拆分，然后再进行数据查询。
   - 即：避免不符合条件的数据被查询出来，减少磁盘I/O。如下SQL，会对条件进行拆分
      ```sql
        #前提: 在字段salary上有索引
         SELECT
	      * 
         FROM
            salaeies 
         WHERE (from_date BETWEEN '1986-01-01' AND '1995-01-01' )  AND ( salary BETWEEN 38000 AND 40000 );
      ```
      - 拆分为: (38000,('1986-01-01','1995-01-01'))、(38001,('1986-01-01','1995-01-01')).........(40000,('1986-01-01','1995-01-01'))






------

## 参考资料
1. 最好的文档: 官方文档:[https://dev.mysql.com/doc/refman/5.7/en/mrr-optimization.html](https://dev.mysql.com/doc/refman/5.7/en/mrr-optimization.html)
2. 《MySQL技术内幕InnoDB存储引擎第2版》